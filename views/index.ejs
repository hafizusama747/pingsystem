<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ping Pong RTT with Connection Stability and Packet Loss</title>
    <!-- Add Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Connect to the server using Socket.IO
        const socket = io();

        // Variables to track ping status
        let unstablePingCount = 0;  // Count consecutive unstable pings
        const maxUnstablePings = 10;  // Max number of unstable pings before disconnect
        let missedPings = 0;  // Count missed pings (packet loss)
        let totalPings = 0;  // Count total pings sent

        // Timeout for missed ping (in milliseconds)
        const pingTimeout = 5000; // Timeout of 5 seconds (for missing pong)

        // Function to send a ping to the server
        function sendPing() {
            const uid = Math.random().toString(36).substring(7);  // Generate unique ID
            const sendTime = Date.now();  // Current timestamp when ping is sent

            console.log(`Sending ping with UID: ${uid} at ${sendTime}`);

            // Increment total ping count
            totalPings++;

            // Create a timeout for missed ping (if no pong is received)
            const pingTimeoutId = setTimeout(() => {
                console.log(`Ping with UID: ${uid} was missed (no pong received within timeout).`);
                missedPings++;  // Increment missed ping count
                updatePacketLossDisplay();
            }, pingTimeout);

            // Send the "ping" message to the server
            socket.emit('ping', { uid, sendTime, pingTimeoutId });
        }

        // Listen for the "pong" message from the server
        socket.on('pong', (data) => {
            const receiveTime = Date.now();  // Timestamp when pong is received
            const sendTime = data.sendTime;  // Timestamp from the ping sent earlier
            const pingTimeoutId = data.pingTimeoutId;  // Timeout ID from the ping sent earlier

            // Clear the timeout for missed ping, since pong was received
            clearTimeout(pingTimeoutId);

            // Calculate RTT using client-side timestamps
            const rtt = receiveTime - sendTime;
            console.log(`Received pong with UID: ${data.uid}`);
            console.log(`RTT: ${rtt} ms`);

            // Evaluate connection stability
            if (rtt < 200) {
                console.log("Connection is stable");
                unstablePingCount = 0;  // Reset unstable ping count
                displayConnectionStatus('Stable', rtt);
            } else if (rtt >= 200 && rtt <= 300) {
                console.log("Connection is unstable");
                displayConnectionStatus('Unstable', rtt);
            } else {
                console.log("Connection is very unstable");
                displayConnectionStatus('Very Unstable', rtt);
                unstablePingCount++;  // Increment unstable ping count
            }

            // Check if unstable ping count exceeds the threshold
            if (unstablePingCount >= maxUnstablePings) {
                console.log("Disconnecting player due to poor connection...");
                socket.emit('disconnectPlayer');  // Emit the custom event to disconnect
                displayConnectionStatus('Disconnected due to high ping', rtt);
            }

            updatePacketLossDisplay();
        });

        // Function to display connection status in the UI (or log to console)
        function displayConnectionStatus(status, rtt) {
            const statusElement = document.getElementById('status');
            statusElement.innerHTML = `Ping Status: ${status} | RTT: ${rtt} ms`;
        }

        // Function to update packet loss display
        function updatePacketLossDisplay() {
            const lossPercentage = (missedPings / totalPings) * 100;
            const lossElement = document.getElementById('packetLoss');
            lossElement.innerHTML = `Packet Loss: ${missedPings} missed pings (${lossPercentage.toFixed(2)}%)`;
        }

        // Send ping every 5 seconds (as an example)
        setInterval(sendPing, 3000);
    </script>
</head>
<body class="bg-light">

    <!-- Main Container -->
    <div class="container py-5">

        <!-- Page Heading -->
        <div class="row">
            <div class="col text-center">
                <h1 class="display-4 text-primary">Ping Pong RTT with Connection Stability and Packet Loss</h1>
                <p class="lead text-muted">Open the browser console to see the RTT logs.</p>
            </div>
        </div>

        <!-- Connection Status Card -->
        <div class="row">
            <div class="col-lg-6 mx-auto">
                <div class="card shadow-lg border-light">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Connection Status</h5>
                    </div>
                    <div class="card-body">
                        <p id="status" class="h5 text-center">Ping Status: Connecting...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Packet Loss Card -->
        <div class="row mt-4">
            <div class="col-lg-6 mx-auto">
                <div class="card shadow-lg border-light">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">Packet Loss</h5>
                    </div>
                    <div class="card-body">
                        <p id="packetLoss" class="h5 text-center">Packet Loss: 0 missed pings (0%)</p>
                    </div>
                </div>
            </div>
        </div>

    </div> <!-- End of Container -->

    <!-- Add Bootstrap JS and dependencies -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
